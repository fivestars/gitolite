import os

from git import Repo


class VREF(object):
    "Base class for VREF with push information"
    def __init__(self, oldsha, newsha, repo_path):
        self.gl_user = os.environ['GL_USER']

        self.oldsha = oldsha
        self.newsha = newsha
        self.repo = Repo(repo_path)

        self.commit_hashes = self.get_all_commits(oldsha, newsha)

    def fallthru(self, **kwargs):
        "Prints failure message and VREF fallthru text"
        print self.CHECK_FAIL_MESSAGE.format(**kwargs)
        print self.FALLTHRU

    def get_files_in_commit(self, commit_hash):
        return self.repo.git.show('--pretty=format:', '--name-only', commit_hash).split()

    def read_git_file(self, path, commit='HEAD'):
        return self.repo.git.cat_file('-p', commit + ':' + path)

    def get_all_commits(self, oldsha, newsha):
        commits = self.repo.commit(newsha).iter_parents()
        next_commit = commits.next()

        commit_hashes = [newsha]
        while next_commit.hexsha != oldsha:
            commit_hashes.append(next_commit.hexsha)
            next_commit = commits.next()

        return commit_hashes
